(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[16],{1063:function(t,E,b){function a(da){var xa=this;da=void 0===da?null:da;this.FS=0;this.WO=null;this.$vg=0;var Z=X.a.Qd();this.prg=this.Efh(da).then(function(ha){return ha?xa.m$h():(u.ULS.sendTraceTag(527827277,3E3,15,"DetermineAuthLibrary failed leaving {0} in {1} ms, all future TryGetToken requests will fail.",xa.Pu(),Math.floor(X.a.Qd()-Z)),ha=U.a.Er(),void 0!==ha&&null!==ha&&(ha.set("AuthLibrary",xa.Pu()),ha=Object.assign(new ea.a,
{durationMs:Math.floor(X.a.Qd()-Z),extendedProperties:ha}),Q.Health.instance.recordKpiFailure(a.kpiName,"StrategyPickFailed",!1,!0,ha)),Promise.resolve(1))}).then(function(ha){return 0!==ha?Promise.resolve(ha):xa.Rti()})}function c(da){this.CPc=da;this.JXa="UnsupportedAuthTokenStrategy Reason="+z.a[this.CPc]}function d(){this.Bs=null;this.DTb=0;this.gkb=this.YXa=this.pFc=this.QDa=this.RL=this.zie=null;this.yv=new B.a(null,null);this.eYb=D.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SharedAuthVNext",
!1);this.JXa="SharedAuthTokenStrategy "+(this.eYb?"BrowserAuth 1.20210701.2/MSAL 2.11.0":"BrowserAuth 1.20210426.1/MSAL 2.11.0");this.bY=H.a.Dwj;this.zge=H.a.Cwj;this.T5d=H.a.enableConsoleLogging;this.Qog=D.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.OAuthPopupFlashEnabled",!1);this.Ixg=D.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.OAuthSkipUpnCheckEnabled",this.eYb);this.$qa={};this.Arg=new k(1500)}function e(da,xa,Z,ha,ya,va,bb){var ba=
O.call(this,!1,!1,!0)||this;ba.z1=null;ba.h5d=null;ba.bY=da;ba.ovg=Z;ba.yv=ha;ba.izg=ya;ba.QDa=va;ba.Bs=document.createElement("iframe");ba.Bs.id="SharedAuthInteractiveFrame";ba.Bs.setAttribute("name","SharedAuthInteractiveFrame");ba.Bs.setAttribute("title","SharedAuthInteractiveFrame");ba.Bs.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-popups");ba.Bs.style.border="0";ba.Bs.style.height="48px";ba.Bs.style.width="190px";$addHandler(ba.Bs,"error",Object(S.a)(ba,ba.eTi,"onSharedAuthFrameError"));
da=String.format("{0}{1}{2}{3}{4}{5}{6}{7}{8}",ba.bY,xa,"?replyUrl=",window.location.protocol,"//",window.location.host,"&interactive=1","&WacUserType=",D.AFrameworkApplication.userType);bb&&(da+="&vnext=1");ba.Bs.src=da;ba.xog=new Promise(function(fa){ba.h5d=fa});ba.i5d=!1;return ba}function h(){this.correlationId=this.resolve=null}function k(da){da=void 0===da?0:da;this.JB=0;this.Vkb=!1;this.sm=new T.a;this._timeout=da}function n(){this.reject=this.resolve=null;this.startTime=0;this.eKf=this.vte=
null}function f(){this.Aje=null;var da=D.AFrameworkApplication.fa.Wa(D.AFrameworkApplication.xea),xa=D.AFrameworkApplication.fa.Wa(D.AFrameworkApplication.Dbg);this.JXa=String.format("ParentFrameTokenStrategy uiHost={0} uiHostIntegrationType={1}",da&&""!==da?da:"Unspecified",xa&&""!==xa?xa:"Unspecified")}function v(da,xa,Z,ha,ya){this.scope=this.resource=null;this.silentLogin=!1;this.correlationId=this.options=null;this.resource=da;this.scope=xa;this.silentLogin=Z;this.options=ha;this.correlationId=
ya}function m(){}function x(da){this.Ktg=da}function l(){}b.r(E);t=b(0);var u=b(15),A=b(913),z=b(1140),y;(function(da){da[da.external=0]="external";da[da.msa=1]="msa";da[da.aad=2]="aad"})(y||(y={}));Object(t.b)("AuthorityType",y);Object(t.a)(l,"OAuthResult",null,[]);x.prototype.initialize=function(){return Promise.resolve(0)};x.prototype.fkc=function(){return Promise.resolve(0)};x.prototype.EO=function(){u.ULS.sendTraceTag(574239257,3E3,50,"Automation flag set.  Returning Mock Token.");return Promise.resolve(Object.assign(new l,
{IsSuccess:!0,Token:this.Ktg}))};x.prototype.XAc=function(){return Promise.resolve(Object.assign(new l,{IsSuccess:!1,ErrorCode:"authTokenStrategy_loginNotSupported",ErrorMessage:"This Token Strategy does not support login flow, TryLogin could not be completed"}))};x.prototype.wzc=function(){return!1};x.prototype.Bwb=function(){return"MockAuthTokenStrategy"};Object(t.a)(x,"MockAuthTokenStrategy",null,[537]);var w=b(1165);m.get=function(da,xa,Z){if(!Z)return da;var ha=0;return Promise.race([da,new Promise(function(ya){ha=
window.setTimeout(function(){ya(xa)},Z)})]).then(function(ya){window.clearTimeout(ha);return Promise.resolve(ya)}).catch(function(){window.clearTimeout(ha);return Promise.resolve(xa)})};Object(t.a)(m,"PromiseWithTimeout",null,[]);var D=b(4),H=b(953);Object(t.a)(v,"TokenRequestParameters",null,[555]);var F=b(27),J=b(83);f.prototype.initialize=function(){var da=this;return new Promise(function(xa){J.a.instance.Tb("Common.App.WopiIdentity.IWopiIdentity").execute(function(Z){da.Aje=Z;xa(0)})})};f.prototype.li=
function(da){for(var xa=!1,Z=da.toLocaleUpperCase(),ha=ik(["HTTPS:","API:"]),ya=ha.next();!ya.done;ya=ha.next())if(Z.startsWith(ya.value)){xa=!0;break}return xa||this.Dji(da)?da+"/.default":da};f.prototype.Dji=function(da){return RegExp("/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i").test(da)};f.prototype.fkc=function(){return Promise.resolve(0)};f.prototype.EO=function(da,xa,Z,ha,ya,va,bb){if(F.a.mxa){ya=H.a.qYj;if(!ya)return xa=Object.assign(new l,{IsSuccess:!1,ErrorCode:"TeamsNoAllowListFound",
ErrorMessage:"No app list was found."}),Promise.resolve(xa);if(!Array.contains(ya,da))return xa=Object.assign(new l,{IsSuccess:!1,ErrorCode:"TeamsDisallowedApp",ErrorMessage:"Disallowed appName: "+da}),Promise.resolve(xa)}da=this.li(Z);Z=new v(Z,da,!ha,null,D.AFrameworkApplication.userSessionId);return this.Aje.getAccessToken(Z,xa,bb).then(function(ba){return Object.assign(new l,{IsSuccess:!0,Token:ba.accessToken})},function(ba){return Object.assign(new l,{IsSuccess:!1,ErrorCode:ba})})};f.prototype.XAc=
function(){return Promise.resolve(Object.assign(new l,{IsSuccess:!1,ErrorCode:"authTokenStrategy_loginNotSupported",ErrorMessage:"This Token Strategy does not support login flow, TryLogin could not be completed"}))};f.prototype.wzc=function(){return!1};f.prototype.Bwb=function(){return this.JXa};Object(t.a)(f,"ParentFrameTokenStrategy",null,[537]);var S=b(84),N=b(1072),T=b(192);Object(t.a)(n,"PromiseWrapper",null,[]);k.prototype.enqueue=function(da){var xa=this;return new Promise(function(Z,ha){xa.sm.add(Object.assign(new n,
{eKf:da,resolve:Z,reject:ha}));xa.process()})};k.prototype.process=function(){var da=this;if(this.Vkb||this.JB===this.sm.count)return!1;var xa=this.sm.na(this.JB++);try{this.Vkb=!0,xa.eKf().then(function(Z){da.Vkb=!1;da.Y1c(xa,Z,null,!0)}).catch(function(Z){da.Vkb=!1;da.Y1c(xa,null,Z,!1)})}catch(Z){this.Vkb=!1,this.Y1c(xa,null,Z,!1)}return!0};k.prototype.Y1c=function(da,xa,Z,ha){var ya=this;ha?0<this._timeout?window.setTimeout(function(){da.resolve(xa);ya.process()},this._timeout):(da.resolve(xa),
ya.process()):0<this._timeout?window.setTimeout(function(){da.reject(Z);ya.process()},this._timeout):(da.reject(Z),ya.process())};Object(t.a)(k,"PromiseQueue",null,[]);Object(t.a)(h,"ResolveWithCorrelation",null,[]);var G=b(85),I=b(150),K=b(1040),L=b(170),O=I.a;$k(e,O);e.prototype.Lxc=function(){var da={};da=(da.promptMessage=this.ovg,da.errorText=CommonUIStrings.l_InternalError,da.rtl=D.AFrameworkApplication.isRtl,da.frameLoaded=!1,da.createFrame=Object(S.a)(this,this.T7g,"createFrame"),da.resolveDialogStyles=
this.h5d,da);var xa={};this.z1=(xa.id="SharedAuthConsentDialog",xa.bodyControls=da,xa);this.Rb=5;this.initializeAndShow(CommonUIStrings.l_SignIn,Object(S.a)(this,this.Bwj,"sharedAuthConsentDialogHandler"),this.z1)};e.prototype.oCc=function(da,xa,Z){da=void 0===da?!1:da;xa=void 0===xa?!1:xa;Z=void 0===Z?5:Z;this.z1&&this.z1.bodyControls&&(da!==Object(G.a)(Object,this.z1.bodyControls).frameLoaded&&(Object(G.a)(Object,this.z1.bodyControls).frameLoaded=da),xa!==Object(G.a)(Object,this.z1.bodyControls).frameLoadSuccess&&
(Object(G.a)(Object,this.z1.bodyControls).frameLoadSuccess=xa),Z!==this.z1.dialogButtonsOption&&(this.z1.dialogButtonsOption=null,this.Rb=Z),this.update(this.z1))};e.prototype.QCj=function(da,xa){var Z=new K.a(L.a.Fwj),ha={};da=(ha.signInLabel=CommonUIStrings.l_SignIn,ha.cancelLabel=CommonUIStrings.l_DialogCancel,ha.rtl=D.AFrameworkApplication.isRtl,ha.messageCorrelationId=da,ha.dialogStyles=xa,ha);Z.Values=da;this.yv.rRa(Z,this.Bs.contentWindow,this.bY)};e.prototype.OUe=function(){this.oCc(!0,!1,
6)};e.prototype.eTi=function(){this.OUe()};e.prototype.T7g=function(){return this.Bs};e.prototype.Bwj=function(da){0===da&&(this.izg.reject(Object.assign(new l,{ErrorCode:"UserCancelled",ErrorMessage:"The interactive flow was cancelled by the user"})),this.QDa(null))};of.Object.defineProperties(e.prototype,{z1f:{configurable:!0,enumerable:!0,get:function(){return this.Bs}},rgh:{configurable:!0,enumerable:!0,get:function(){var da=this;return this.xog.then(function(xa){da.i5d=!0;return xa})}},sgh:{configurable:!0,
enumerable:!0,get:function(){return this.i5d}}});Object(t.a)(e,"SharedAuthConsentDialog",I.a,[554]);var B=b(1452),Q=b(99),U=b(136),X=b(39),P=b(178),ea=b(193);d.prototype.Bwb=function(){return this.JXa};d.prototype.initialize=function(){var da=b(1063).OAuthManager;if("loadFrame"in this.$qa)return this.$qa.loadFrame.vte;if(!this.bY)return Q.Health.instance.recordKpiFailure(da.kpiName,"SharedAuthFrameOriginNotSet",!1,!1,null),u.ULS.sendTraceTag(562381581,3E3,10,"SharedAuthTokenStrategy Init failed: No Shared Frame Origin Path"),
Promise.reject(1);da=this.czc("loadFrame");this.DTb=X.a.Qd();var xa=this.bY+this.zge+"?replyUrl="+window.location.protocol+"//"+window.location.host+"&usid="+D.AFrameworkApplication.userSessionId+"&WacUserType="+D.AFrameworkApplication.userType;this.eYb&&(xa+="&vnext=1");this.Bs=document.createElement("iframe");this.Uai(this.Bs);this.Bs.style.cssText="height:0;width:0;display:none;";this.Bs.id="SharedAuthFrame";this.Bs.setAttribute("name","SharedAuthFrame");this.Bs.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-popups");
this.Bs.setAttribute("title","SharedAuthFrame");this.Bs.src=xa;document.body.appendChild(this.Bs);xa=X.a.Qd()-this.DTb;u.ULS.sendTraceTag(573112899,3E3,50,"SharedAuthTokenStrategy Create: Frame Appended to Document. E/T:[{0}]. sharedAuthFrame.Src={1}",xa,this.Bs.src);return da};d.prototype.fkc=function(da){this.pFc=da;var xa=new K.a(L.a.C1f);xa.Values=this.Yse(da);da=this.czc("initFrame");this.yv.rRa(xa,this.Bs.contentWindow,this.bY);u.ULS.sendTraceTag(573112900,3E3,50,"SharedAuthTokenStrategy Init: Called package initialize.");
return da};d.prototype.EO=function(da,xa,Z,ha,ya,va){var bb=this,ba=new K.a(L.a.Gwj),fa=this.L1e();ba.Values=this.Yag(da,xa,Z,ha,ya,va,fa);da=this.czc(fa);ha&&D.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SharedAuthInteractiveConsentUI",!1)?this.Arg.enqueue(function(){return new Promise(function(ra){bb.UOj(va,ba,ra,fa)})}):(this.yv.rRa(ba,this.Bs.contentWindow,this.bY),u.ULS.sendTraceTag(573112901,3E3,50,"SharedAuthTokenStrategy TryGetToken: Called TryGetToken for app {0}",
xa));return da};d.prototype.UOj=function(da,xa,Z,ha){var ya=this.$qa[ha];ya&&(this.YXa=xa,this.QDa=Object.assign(new h,{resolve:Z,correlationId:ha}),this.RL=new e(this.bY,this.zge,da,this.yv,ya,Z,this.eYb),this.RL.Lxc())};d.prototype.L1e=function(){return P.a.create().toString()};d.prototype.Yag=function(da,xa,Z,ha,ya,va,bb){var ba={};ba.appName=da;ba.appId=xa;ba.target=Z;ba.withPopup=ha;ba.claims=ya;ba.promptMessage=va;ba.messageCorrelationId=bb;return ba};d.prototype.Uai=function(da){$addHandler(da,
"load",Object(S.a)(this,this.hOi,"onIFrameLoaded"));$addHandler(da,"error",Object(S.a)(this,this.Fnc,"onIFrameError"));this.yv.LFa(this.bY);this.yv.Tn(L.a.F1f);this.yv.Ml(L.a.F1f,Object(S.a)(this,this.wSi,"onScriptLoaded"));this.yv.Tn(L.a.E1f);this.yv.Ml(L.a.E1f,Object(S.a)(this,this.vSi,"onScriptInitialized"));this.yv.Tn(L.a.A1f);this.yv.Ml(L.a.A1f,Object(S.a)(this,this.INi,"onGetTokenResponse"));this.yv.Tn(L.a.G1f);this.yv.Ml(L.a.G1f,Object(S.a)(this,this.xPi,"onLoginResponse"));this.yv.Tn(L.a.D1f);
this.yv.Ml(L.a.D1f,Object(S.a)(this,this.COi,"onInteractiveFlowReady"));this.yv.Tn(L.a.B1f);this.yv.Ml(L.a.B1f,Object(S.a)(this,this.$Ni,"onHideDialog"));this.yv.Tn(L.a.y1f);this.yv.Ml(L.a.y1f,Object(S.a)(this,this.aJi,"onCloseDialog"))};d.prototype.czc=function(da){var xa=new n;xa.startTime=X.a.Qd();var Z=new Promise(function(ha,ya){xa.resolve=ha;xa.reject=ya});xa.vte=Z;this.$qa[da]=xa;return Z};d.prototype.hOi=function(){var da=X.a.Qd()-this.DTb;u.ULS.sendTraceTag(572346566,3E3,50,"WACOAuth.aspx iFrame loaded successfully. E/T:[{0}]",
da)};d.prototype.Fnc=function(da){var xa=b(1063).OAuthManager,Z=X.a.Qd()-this.DTb,ha=Object.assign(new ea.a,{durationMs:Z});Q.Health.instance.recordKpiFailure(xa.kpiName,"SharedAuthWACOAuthAspxFrameError",!1,!0,ha);u.ULS.sendTraceTag(572346567,3E3,10,"WACOAuth.aspx iFrame failed to load after {0} ms: {1}",Z,this.T5d?JSON.stringify(da):"")};d.prototype.wSi=function(da){var xa=b(1063).OAuthManager,Z=this.$qa.loadFrame,ha=X.a.Qd()-Z.startTime,ya=da.Values.AuthLibrary.toString();da=da.Values.Success.toString();
u.ULS.sendTraceTag(573112902,3E3,50,"SharedAuthTokenStrategy OnScriptLoaded. Success={0} AuthLibrary={1} E/T: [{2}]",da,ya,ha);ya&&(this.JXa="SharedAuthTokenStrategy "+ya);ya=Boolean.parse(da);ya||(da=U.a.Er(),void 0!==da&&null!==da&&(da.set("AuthLibrary",this.Bwb()),ha=Object.assign(new ea.a,{durationMs:ha,extendedProperties:da}),Q.Health.instance.recordKpiFailure(xa.kpiName,"SharedAuthStrategyInitFailed",!1,!0,ha)));Z.resolve(ya?0:1)};d.prototype.vSi=function(da){var xa=this;if(da.Values.interactive&&
this.YXa&&this.YXa.Values.messageCorrelationId){var Z=this.YXa.Values.messageCorrelationId.toString();if(da.Values.interactive&&this.RL){this.RL.rgh.then(function(ya){xa.yv.rRa(xa.YXa,xa.RL.z1f.contentWindow,xa.bY);xa.RL.QCj(Z,ya);xa.RL.oCc(!0,!0);xa.YXa=null});return}}da=this.$qa.initFrame;var ha=X.a.Qd()-da.startTime;u.ULS.sendTraceTag(573112903,3E3,50,"SharedAuthTokenStrategy OnScriptInitialized. E/T: [{0}]",ha);da.resolve(0)};d.prototype.INi=function(da){if(da.Values.messageCorrelationId&&da.Values.messageCorrelationId.toString()){var xa=
da.Values.messageCorrelationId.toString(),Z=this.$qa[xa];if(Z){var ha=X.a.Qd()-Z.startTime;u.ULS.sendTraceTag(573112906,3E3,50,"SharedAuthTokenStrategy OnGetTokenResponse. E/T: [{0}]",ha);da.Values.isSuccess&&da.Values.isSuccess?Z.resolve(da.Values.response):Z.reject(da.Values.response);this.mbg(xa)}else u.ULS.sendTraceTag(573112905,3E3,10,"SharedAuthTokenStrategy OnGetTokenResponse called with an unregistered messageCorrelationId")}else u.ULS.sendTraceTag(573112904,3E3,10,"SharedAuthTokenStrategy OnGetTokenResponse called without valid messageCorrelationId")};
d.prototype.COi=function(){if(this.RL.sgh)this.RL.OUe();else if(this.pFc&&this.RL){var da=new K.a(L.a.C1f);da.Values=this.Yse(this.pFc,!0);this.yv.rRa(da,this.RL.z1f.contentWindow,this.bY)}};d.prototype.$Ni=function(){this.RL&&this.RL.Oxb()};d.prototype.aJi=function(da){da.Values.cancelled&&da.Values.cancelled&&da.Values.messageCorrelationId&&this.mbg(da.Values.messageCorrelationId.toString());this.RL&&this.RL.hide()};d.prototype.Yse=function(da,xa){xa=void 0===xa?!1:xa;var Z={};Z.appIds=this.oJh();
Z.upn=da.loginHint;Z.authority=da.authority;Z.authorityType=Object(A.a)(y,da.authorityType);Z.tenantId=da.tenantId;Z.correlationId=D.AFrameworkApplication.userSessionId;Z.enableConsoleLogging=this.T5d;Z.enablePopupFlash=this.Qog;Z.skipUpnCheck=this.Ixg;Z.interactive=xa;return Z};d.prototype.oJh=function(){var da=[],xa=H.a.wWc,Z;for(Z in xa)Array.add(da,xa[Z]);return da};d.prototype.XAc=function(da,xa,Z,ha,ya,va){var bb=new K.a(L.a.Ewj),ba=this.L1e();bb.Values=this.Yag(da,xa,Z,ha,ya,va,ba);this.zie=
bb;da=this.czc(ba);u.ULS.sendTraceTag(555049437,3E3,50,"SharedAuthTokenStrategy TryLogin: Called TryLogin for app {0}",xa);this.yAj();return da};d.prototype.wzc=function(){return!0};d.prototype.yAj=function(){var da=this;this.gkb||(this.gkb=new N.a(CommonUIStrings.l_WAC_OAuth_CompleteSignIn_Title,CommonUIStrings.l_WAC_OAuth_CompleteSignIn_Body,null),this.gkb.id=16,this.gkb.jff=!1,this.gkb.addButton(CommonUIStrings.l_WAC_OAuth_CompleteSignIn_Button,function(){u.ULS.sendTraceTag(527827290,3E3,50,"SharedAuthTokenStrategy TryLogin: User Clicked Login");
da.yv.rRa(da.zie,da.Bs.contentWindow,da.bY)},CommonUIStrings.l_WAC_OAuth_CompleteSignIn_Button,!0),u.ULS.sendTraceTag(555049438,3E3,10,"Failed to add entry to business bar. Login message could not be shown to user."))};d.prototype.xPi=function(da){if(da.Values.messageCorrelationId&&da.Values.messageCorrelationId.toString()){var xa=this.$qa[da.Values.messageCorrelationId.toString()];if(xa){var Z=X.a.Qd()-xa.startTime;u.ULS.sendTraceTag(555049441,3E3,50,"SharedAuthTokenStrategy OnLoginResponse. E/T: [{0}]",
Z);da.Values.isSuccess&&da.Values.isSuccess?xa.resolve(da.Values.response):xa.reject(da.Values.response)}else u.ULS.sendTraceTag(555049440,3E3,10,"SharedAuthTokenStrategy OnLoginResponse called with an unregistered messageCorrelationId")}else u.ULS.sendTraceTag(555049439,3E3,10,"SharedAuthTokenStrategy OnLoginResponse called without valid messageCorrelationId")};d.prototype.mbg=function(da){this.QDa&&this.QDa.correlationId===da&&(this.QDa.resolve(null),this.QDa=null)};Object(t.a)(d,"SharedAuthTokenStrategy",
null,[537]);c.prototype.initialize=function(){return Promise.resolve(0)};c.prototype.fkc=function(){return Promise.resolve(0)};c.prototype.EO=function(){return Promise.resolve(Object.assign(new l,{IsSuccess:!1,ErrorCode:z.a[this.CPc],ErrorMessage:"Unable to get a token. Reason: ["+z.a[this.CPc]+"]"}))};c.prototype.XAc=function(){return Promise.resolve(Object.assign(new l,{IsSuccess:!1,ErrorCode:"authTokenStrategy_loginNotSupported",ErrorMessage:"This Token Strategy does not support login flow, TryLogin could not be completed"}))};
c.prototype.wzc=function(){return!1};c.prototype.Bwb=function(){return this.JXa};Object(t.a)(c,"UnsupportedAuthTokenStrategy",null,[537]);var ia=b(941);b.d(E,"OAuthManager",function(){return a});a.prototype.Ffh=function(){var da=H.a.eCi;da&&0<da.length?(this.FS=1,this.WO=new x(da)):D.AFrameworkApplication.fa.qa("IsO365ConsumerHost")||D.AFrameworkApplication.fa.qa("IsO365CommercialHost")?D.AFrameworkApplication.fa.qa("IsAnonymousUser")?(this.FS=2,this.WO=new c(this.FS)):(da=w.a.getAuthContext().loginHint)&&
da.length?H.a.Sxb?(this.FS=1,this.WO=new f):(this.FS=1,this.WO=new d):(this.FS=3,this.WO=new c(this.FS)):(this.FS=4,this.WO=new c(this.FS))};a.prototype.Pu=function(){return this.WO?this.WO.Bwb()||"Unknown":"None"};a.prototype.Efh=function(da){var xa=this;da=void 0===da?null:da;u.ULS.sendTraceTag(562128578,3E3,50,"Creating OAuthManager.");var Z=X.a.Qd();return D.AFrameworkApplication.fa.xed().then(function(ha){ha?(xa.Ffh(),da&&(xa.WO=da),u.ULS.sendTraceTag(42084323,3E3,50,"Creation succeeded OAuthManager successfully in {4} ms with clientVer={0}, appVer={1}, docVer={2}, strategy={3}",
H.a.clientVersion,H.a.appVersion,H.a.Cih,xa.Pu(),Math.floor(X.a.Qd()-Z))):u.ULS.sendTraceTag(562128579,3E3,15,"Creation failed for OAuthManager, unable to get app settings after {0} ms, all future TryGetToken requests will fail.",Math.floor(X.a.Qd()-Z));return Promise.resolve(ha)},function(){u.ULS.sendTraceTag(562128580,3E3,15,"Creation failed for OAuthManager, unable to get app settings after {0} ms, all future TryGetToken requests will fail.",Math.floor(X.a.Qd()-Z));return Promise.resolve(!1)})};
a.prototype.m$h=function(){var da=this;u.ULS.sendTraceTag(573390991,3E3,50,"Initializing {0}",this.Pu());var xa=X.a.Qd();return m.get(this.WO.initialize(),2,H.a.MFd).then(function(Z){if(0===Z)u.ULS.sendTraceTag(42084353,3E3,50,"Initialization succeeded for {0} in {1} ms.",da.Pu(),Math.floor(X.a.Qd()-xa));else if(1===Z){u.ULS.sendTraceTag(527827291,3E3,15,"Initialization failed for {0} in {1} ms, all future TryGetToken requests will fail.",da.Pu(),Math.floor(X.a.Qd()-xa));var ha=U.a.Er();void 0!==
ha&&null!==ha&&(ha.set("AuthLibrary",da.Pu()),ha=Object.assign(new ea.a,{durationMs:Math.floor(X.a.Qd()-xa),extendedProperties:ha}),Q.Health.instance.recordKpiFailure(a.kpiName,"StrategyInitFailed",!1,!0,ha))}else 2===Z&&(u.ULS.sendTraceTag(42267908,3E3,15,"Initialization timed out for {0} after {1} ms, all future TryGetToken requests will fail.",da.Pu(),Math.floor(X.a.Qd()-xa)),ha=U.a.Er(),void 0!==ha&&null!==ha&&(ha.set("AuthLibrary",da.Pu()),ha=Object.assign(new ea.a,{durationMs:Math.floor(X.a.Qd()-
xa),extendedProperties:ha}),Q.Health.instance.recordKpiFailure(a.kpiName,"StrategyInitTimedOut",!1,!0,ha)));return Promise.resolve(Z)},function(){u.ULS.sendTraceTag(574239256,3E3,15,"Initialization failed for {0} after {1} ms, all future TryGetToken requests will fail.",da.Pu(),Math.floor(X.a.Qd()-xa));return Promise.resolve(1)})};a.prototype.Rti=function(){var da=this;u.ULS.sendTraceTag(562128581,3E3,50,"Loading {0}",this.Pu());var xa=X.a.Qd();return m.get(this.WO.fkc(w.a.getAuthContext()),2,H.a.MFd).then(function(Z){if(0===
Z)u.ULS.sendTraceTag(562128582,3E3,50,"Load succeeded for {0} in {1} ms.",da.Pu(),Math.floor(X.a.Qd()-xa));else if(1===Z){u.ULS.sendTraceTag(562128583,3E3,15,"Load failed for {0} after {1} ms, all future TryGetToken requests will fail.",da.Pu(),Math.floor(X.a.Qd()-xa));var ha=U.a.Er();void 0!==ha&&null!==ha&&(ha.set("AuthLibrary",da.Pu()),ha=Object.assign(new ea.a,{durationMs:Math.floor(X.a.Qd()-xa),extendedProperties:ha}),Q.Health.instance.recordKpiFailure(a.kpiName,"StrategyLoadFailed",!1,!0,ha))}else 2===
Z&&(u.ULS.sendTraceTag(558469660,3E3,15,"Load timed out for {0} after {1} ms, all future TryGetToken requests will fail.",da.Pu(),Math.floor(X.a.Qd()-xa)),ha=U.a.Er(),void 0!==ha&&null!==ha&&(ha.set("AuthLibrary",da.Pu()),ha=Object.assign(new ea.a,{durationMs:Math.floor(X.a.Qd()-xa),extendedProperties:ha}),Q.Health.instance.recordKpiFailure(a.kpiName,"StrategyLoadTimedOut",!1,!0,ha)));return Promise.resolve(Z)},function(){u.ULS.sendTraceTag(562128584,3E3,15,"Load failed for {0} after {1} ms, all future TryGetToken requests will fail.",
da.Pu(),Math.floor(X.a.Qd()-xa));return Promise.resolve(1)})};a.prototype.EO=function(da,xa,Z){return this.VAc(da,xa,!1,null,"",void 0===Z?null:Z)};a.prototype.Zag=function(da,xa,Z,ha,ya){return this.VAc(da,xa,!0,Z,ha,void 0===ya?null:ya)};a.prototype.VAc=function(da,xa,Z,ha,ya,va,bb){bb=void 0===bb?0:bb;bb+=1;u.ULS.sendTraceTag(42084352,3E3,50,"OAuthManager TryGetToken(appName={0}, target={1}) called.  Using strategy {2} - attempt {3}",da,this.ZQa(da,xa),this.Pu(),bb);var ba=U.a.Er();void 0!==ba&&
null!==ba&&(ba.set("AuthLibrary",this.Pu()),ba.set("AppName",da),ba.set("Target",this.ZQa(da,xa)),Q.Health.instance.recordKpiUsage(a.kpiName,0,"WacOAuthFC",ba));if(!H.a.isEnabled){var fa;return this.cud((fa=new l,fa.IsSuccess=!1,fa.Token=null,fa.ErrorCode="NotEnabled",fa.ErrorMessage="OAuthManager is disabled.",fa),da)}var ra=H.a.wWc[da];if(void 0===ra||null===ra){u.ULS.sendTraceTag(41961345,3E3,15,"Auth context not found. Ensure that your app [{0}] is listed in the OAuthManagerApplications setting.",
da);var pa;return this.cud((pa=new l,pa.IsSuccess=!1,pa.Token=null,pa.ErrorCode="DisallowedApp",pa.ErrorMessage="Disallowed appName: "+da,pa),da)}var Za=X.a.Qd(),Ua=this;ba=this.prg.then(function(ta){return Ua.afi(da,ra,xa,Z,ha,ya,va,ta)});fa=Z?0:H.a.MFd;var Ma;pa=(Ma=new l,Ma.IsSuccess=!1,Ma.Token=null,Ma.ErrorCode="authTokenStrategy_timeout",Ma.ErrorMessage="Auth Strategy timed out after ["+fa+"] ms when fetching token",Ma);var oa=this,ja=this;return m.get(ba,pa,fa).then(function(ta){return bb<=
a.LAi&&(ta.ErrorCode===a.g$f||ta.ErrorCode===a.uHj)?(u.ULS.sendTraceTag(573175516,3E3,50,"TryGetToken attempt {0} timed out after {1} ms - retrying",bb,Math.floor(X.a.Qd()-Za)),oa.VAc(da,xa,Z,ha,ya,va,bb)):ta.ErrorCode===a.Jif&&!Z&&(u.ULS.sendTraceTag(561517645,3E3,50,"TryGetToken attempt {0} failed with ITP error.  3P Cookies are [{1}]. Retry: [{2]}]",bb,a.cLe),a.Jlh&&oa.WO.wzc()&&oa.WO.XAc(da,ra,xa,Z,ha,ya).then(function(aa){return Promise.resolve(oa.ykc(aa,da,xa,ra,Za))}).catch(function(){var aa,
ma=(aa=new l,aa.IsSuccess=!1,aa.Token=null,aa.ErrorCode="authTokenStrategy_failure",aa.ErrorMessage="LoginPopup failed, GetToken could not be called",aa);return Promise.resolve(oa.ykc(ma,da,xa,ra,Za))}),a.cLe)?oa.VAc(da,xa,!0,ha,ya,va,bb):Promise.resolve(oa.ykc(ta,da,xa,ra,Za))}).catch(function(){var ta,aa=(ta=new l,ta.IsSuccess=!1,ta.Token=null,ta.ErrorCode="authTokenStrategy_failure",ta.ErrorMessage="Auth Strategy failed with an unknown error",ta);return Promise.resolve(ja.ykc(aa,da,xa,ra,Za))})};
a.prototype.afi=function(da,xa,Z,ha,ya,va,bb,ba){var fa=this;return 1===ba||2===ba?this.cud(Object.assign(new l,{IsSuccess:!1,Token:null,ErrorCode:1===ba?"InitFailed":"InitTimedOut",ErrorMessage:"Auth Strategy Failed to Init or Load"}),da):this.WO.EO(da,xa,Z,ha,ya,va,bb).then(function(ra){return Promise.resolve(fa.rsf(ra,!0,da))}).catch(function(ra){return Promise.resolve(fa.rsf(ra,!1,da))})};a.prototype.ykc=function(da,xa,Z,ha,ya){var va={};ya=X.a.Qd()-ya;va.IsSuccess=da.IsSuccess;va.ErrorCode=da.IsSuccess?
"Success":da.ErrorCode||"";va.ErrorMessage=da.IsSuccess?"Success":this.ZQa(xa,da.ErrorMessage||"");va.Target=this.ZQa(xa,Z||"");va.TimeInMS=Math.floor(ya);va.AuthLibrary=this.Pu();va.AppName=xa;va.AuthorityType=Object(A.a)(y,w.a.vac());va.UserType=this.B0h(w.a.getAuthContext());va.IsAuthSupportedInSession=z.a[this.FS];va.RequestCount=++this.$vg;va.AppId=ha;u.ULS.sendTraceTag(593863640,3E3,50,JSON.stringify(va));da.IsSuccess||(Z=U.a.Er(),void 0!==Z&&null!==Z&&(Z.set("AppName",xa),Z.set("AuthLibrary",
this.Pu()),Z.set("ErrorCode",da.ErrorCode),Z.set("ErrorMessage",this.ZQa(xa,da.ErrorMessage)),xa=Object.assign(new ea.a,{durationMs:ya,extendedProperties:Z}),Q.Health.instance.recordKpiFailure(a.kpiName,"TryGetTokenFailure",!1,!0,xa)));return da};a.prototype.cud=function(da,xa){u.ULS.sendTraceTag(578435090,3E3,15,"OAuthManager failed without invoking GetToken. AppName: '{0}', Reason: '{1}'",xa,this.ZQa(xa,da.ErrorMessage));var Z=U.a.Er();void 0!==Z&&null!==Z&&(Z.set("AppName",xa),Z.set("AuthLibrary",
this.Pu()),Z.set("ErrorCode",da.ErrorCode),Z.set("ErrorMessage",this.ZQa(xa,da.ErrorMessage)),xa=Object.assign(new ea.a,{extendedProperties:Z}),Q.Health.instance.recordKpiFailure(a.kpiName,"FailureBeforeGetToken",!1,!0,xa));return Promise.resolve(da)};a.prototype.Ldf=function(da){return da===ia.a.hAc};a.prototype.ZQa=function(da,xa){return this.Ldf(da)&&xa?"REDACTED":xa};a.prototype.B0h=function(da){return D.AFrameworkApplication.fa.qa("IsAnonymousUser")?"anonymous":!da.loginHint||1>da.loginHint.length?
"empty":-1<da.loginHint.indexOf("guest#")?"guest":-1<da.loginHint.indexOf("ext#")?"external":0>da.upn.indexOf("@")?"no-at":"supported"};a.prototype.Y5a=function(){return 1===this.FS};a.prototype.rsf=function(da,xa,Z){var ha=null,ya=null,va=null,bb=null;da?da.ErrorCode||da.ErrorMessage?(ya=da.ErrorCode?da.ErrorCode:a.jRe,va=da.ErrorMessage?da.ErrorMessage:"No message"):da.Token?xa?ha=da.Token:(ya=a.Y$i,va="A rejected promise returned a token."):(ya=a.jRe,va=JSON.stringify(da)):(ya=a.HEi,va="No result came from Auth Token Strategy");
da&&da.Telemetry&&!this.Ldf(Z)&&(bb=da.Telemetry,u.ULS.sendTraceTag(579166408,3E3,50,JSON.stringify(bb)));if(ya===a.qCi||ya===a.hMj)ya=a.g$f,va="Auth Library Timed Out";ya===a.$Ng&&-1<va.indexOf(a.bAg)&&(ya=a.Jif);if(ya||va)ha=null;return Object.assign(new l,{IsSuccess:!!ha,Token:ha,ErrorCode:ya,ErrorMessage:va,Telemetry:bb})};of.Object.defineProperties(a,{cLe:{configurable:!0,enumerable:!0,get:function(){return D.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.OAuthInteractiveFallbackEnabled",
!1)}},Jlh:{configurable:!0,enumerable:!0,get:function(){return D.AFrameworkApplication.fa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.OAuthLoginFlowEnabled",!1)}}});a.hMj="token_renewal_error";a.jRe="Exception";a.HEi="NoResult";a.Y$i="RejectToken";a.qCi="monitor_window_timeout";a.g$f="Timeout";a.uHj="authTokenStrategy_timeout";a.$Ng="login_required";a.bAg="AADSTS50058";a.Jif="Cookies Disabled";a.kpiName="OAuthManager";a.LAi=2;Object(t.a)(a,"OAuthManager",null,[502])},1140:function(t,E,b){b.d(E,
"a",function(){return a});t=b(0);var a;(function(c){c[c.unknown=0]="unknown";c[c.supported=1]="supported";c[c.userUnsupportedAnonymous=2]="userUnsupportedAnonymous";c[c.userUnsupportedNoLoginHint=3]="userUnsupportedNoLoginHint";c[c.hostUnsupported=4]="hostUnsupported"})(a||(a={}));Object(t.b)("SupportStatus",a)},1425:function(t,E,b){function a(){Type.registerNamespace("Common.App.LivePersonaUtils");c.main()}function c(){}function d(m){this.jVb=m}function e(){}t=b(0);var h=b(1165),k=b(4);Object(t.a)(e,
"LokiTokenResult",null,[]);d.prototype.gfd=function(){var m=this,x=this.MSh();return x?d.npd?new Promise(function(l,u){m.jVb.continueWith(function(){m.jVb.sh||m.jVb.Of?u(Error.create("Error downloading auth library")):m.jVb.result.EO("Loki",x).then(function(A){A=k.AFrameworkApplication.fa.qa("ForceLokiFallbackToACLPTokenIsEnabled")?m.PSh():A.IsSuccess&&A.Token?Object.assign(new e,{isSuccess:!0,token:A.Token,errorMessage:null}):Object.assign(new e,{isSuccess:!1,token:null,errorMessage:JSON.stringify(A)});
l(A);return A})})}):Promise.resolve(Object.assign(new e,{isSuccess:!1,token:null,errorMessage:"Not attempting to fetch token because host is not an O365 host."})):Promise.resolve(Object.assign(new e,{isSuccess:!1,token:null,errorMessage:String.format("Could not get Loki App Id for HostAuthorityType: [{0}]",h.a.UWe())}))};d.prototype.PSh=function(){var m=k.AFrameworkApplication.fa.Wa("LokiUserDataSignature")||"";return Object.assign(new e,{isSuccess:!0,token:m,errorMessage:null})};d.prototype.MSh=
function(){var m=null,x=h.a.vac();2===x?m=k.AFrameworkApplication.fa.Wa("LokiAADAppId"):1===x&&(m=k.AFrameworkApplication.fa.Wa("LokiMSAAppId"));return m};of.Object.defineProperties(d,{npd:{configurable:!0,enumerable:!0,get:function(){return k.AFrameworkApplication.fa.qa("IsO365CommercialHost")||k.AFrameworkApplication.fa.qa("IsO365ConsumerHost")}}});Object(t.a)(d,"LokiTokenManager",null,[740]);var n=b(258),f=b(83),v=b(575);c.prototype.init=function(){f.a.instance.resolve("Common.ILokiTokenManager")};
c.prototype.dispose=function(){};c.prototype.Sh=function(m){m.register(d,"Common.App.LivePersonaUtils.LokiTokenManager").as("Common.ILokiTokenManager").tc().Dc(function(){return new d(v.a.Kq(m.Tb("Common.App.OAuth.IOAuthManager")))})};c.main=function(){n.a.instance.Qi(new c)};of.Object.defineProperties(c.prototype,{name:{configurable:!0,enumerable:!0,get:function(){return"Common.App.LivePersonaUtils"}}});Object(t.a)(c,"LivePersonaUtilsPackage",null,[10,11]);b.d(E,"a",function(){return a})},1461:function(t,
E,b){function a(){Type.registerNamespace("Common.App.OAuth");c.main()}function c(){}t=b(0);var d=b(15),e=b(1063),h=b(1140),k=b(4),n=b(99),f=b(953),v=b(258),m=b(42),x=b(39),l=b(27),u=b(113),A=b(83),z=b(193);c.prototype.Sh=function(y){y.register(502,"Common.App.OAuth.IOAuthManager").tc().Dc(function(){return new e.OAuthManager})};c.prototype.init=function(){var y=A.a.instance.resolve("Common.App.OAuth.IOAuthManager");this.EPj(y)};c.prototype.EPj=function(y){var w=k.AFrameworkApplication.fa.Wa("FileSource");
if(k.AFrameworkApplication.fa.qa("IsO365ConsumerHost")||k.AFrameworkApplication.fa.qa("IsO365CommercialHost")||"WopiTest"===w){var D=f.a.X4g;if(D&&D.IsEnabled){var H=D.Application,F=f.a.authority;if(void 0!==H&&null!==H&&H.length&&void 0!==F&&null!==F&&F.length){var J=h.a[y.FS],S=l.a.IGa,N=y.Pu();try{var T=new Map;void 0!==T&&null!==T?(T.set("SupportStatus",J),T.set("Browser",S),T.set("AuthStrategy",N)):T=null}catch(I){T=null}n.Health.instance.recordKpiUsageForAlertableKpi("WacCorePFT","WacOAuthFC",
T);var G=x.a.Qd();y.EO("Core",H).then(function(I){var K=Math.floor(x.a.Qd()-G);J=h.a[y.FS];S=l.a.IGa;N=y.Pu();d.ULS.sendTraceTag(562943369,3E3,50,'OAuthManager attempted to get a Core token to the WAC FrontEnd API in {0} ms. Success={1}, SupportStatus={2}, ErrorCode="{3}", Host="{4}", Browser="{5}", AuthStrategy="{6}"',K,I.IsSuccess,J,I.ErrorCode,w,S,N);T&&(T.set("SupportStatus",J),T.set("Browser",S),T.set("AuthStrategy",N));var L=Object.assign(new z.a,{durationMs:K,extendedProperties:T});if(I.IsSuccess){if(n.Health.instance.recordKpiSuccess("WacCorePFT",
L),L=D.Endpoint){var O=x.a.Qd(),B={};I=(B.Authorization="Bearer "+I.Token,B);k.AFrameworkApplication.nd.unb(L,1,null,I,"OAuthManagerValidateAccess",void 0,void 0,void 0,2E4).continueWith(function(Q){var U=Math.floor(x.a.Qd()-O),X=null;Q.sh?Q="Canceled":Q.Of?Q="Faulted":(X=Q.result,Q=X.succeeded?"Completed":"Failed");var P={};U=(P.TaskResult=Q,P.BrowserTokenDurationMS=K,P.BrowserValidationDurationMS=U,P);X&&(U.HttpStatus=X.Eg.data.httpStatus,X.succeeded&&(X=m.a(X.Eg.data.Rd),U.ServerValidationDurationMS=
X.ElapsedMilliseconds,U.ServerValidationResult=X.ValidatedToken,U.KMSI=X.KMSI,U.Scopes=X.Scopes,U.TokenExpirationS=Math.floor(parseInt(X.Expiration)-(new Date).getTime()/1E3)));d.ULS.sendTraceTag(520632322,3E3,"Completed"===Q?50:15,u.a.toJSON(U))})}}else n.Health.instance.recordKpiFailure("WacCorePFT",I.ErrorCode,!1,!1,L)}).catch(function(I){var K=Math.floor(x.a.Qd()-G);K=Object.assign(new z.a,{durationMs:K,extendedProperties:T});n.Health.instance.recordKpiFailure("WacCorePFT","UNEXPECTED CATCH: "+
I.toString(),!1,!1,K)})}}}};c.prototype.dispose=function(){};c.main=function(){v.a.instance.Qi(new c)};of.Object.defineProperties(c.prototype,{name:{configurable:!0,enumerable:!0,get:function(){return"Common.App.OAuth.OAuthPackage"}}});Object(t.a)(c,"OAuthPackage",null,[10,11]);b.d(E,"a",function(){return a})},1462:function(t,E,b){function a(){e.a.Fa(function(l){c.ka(l)})}function c(l){var u=x.call(this)||this;u.$=l;u.Eb();return u}function d(l){this.oAuthManager=l}var e=b(10);t=b(0);var h=b(83),
k=b(235),n=b(7),f=b(15),v=b(1034);d.prototype.EO=function(l,u){return this.oAuthManager?this.oAuthManager.EO(l,u).then(function(A){A.IsSuccess||f.ULS.sendTraceTag(51401292,0,15,"Error retrieving auth token. Message: "+A.ErrorMessage+" Error code: "+A.ErrorCode+" App name: "+l);return Object(n.a)(new v.a,{IsSuccess:A.IsSuccess,Token:A.Token,ErrorCode:A.ErrorCode,ErrorMessage:A.ErrorMessage})}):(f.ULS.sendTraceTag(537154971,0,10,"Oauth manager is null"),Promise.resolve(Object(n.a)(new v.a,{IsSuccess:!1,
Token:null,ErrorCode:"FailedToResolve",ErrorMessage:"Failed to resolve IOAuthManager from the container."})))};d.prototype.Y5a=function(){return this.oAuthManager?this.oAuthManager.Y5a():null};Object(t.a)(d,"OAuthManagerWrapper",null,[503]);var m=b(921),x=k.a;$k(c,x);c.prototype.create=function(){this.pb(Object(m.a)(this.$.da,349,function(){return new d(h.a.instance.resolve("Common.App.OAuth.IOAuthManager"))}))};c.ka=function(l){l.da.Ga(350,new c(l))};Object(t.a)(c,"OAuthManagerFactory",k.a,[]);b.d(E,
"a",function(){return a})},1672:function(t,E,b){b.r(E);t=b(1461);E=b(1425);b=b(1462);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.AppsForOfficeCommon");Object(t.a)();Object(E.a)();Object(b.a)()}}]);

//# sourceMappingURL=EwaDS.oauth.js.map